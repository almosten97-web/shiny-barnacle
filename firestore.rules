firebase.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper to get the authenticated user's role
    function getRole() {
      return get(/databases/$(database)/documents/employees/$(request.auth.uid)).data.role;
    }

    // Global read access for any authenticated user
    match /{document=**} {
      allow read: if request.auth != null;
    }

    // Rules for the 'employees' collection
    match /employees/{employeeId} {
      // Any authenticated user can read employee profiles (covered by global read)
      
      // Managers can create new employee profiles
      allow create: if request.auth != null && getRole() == 'manager';

      // Managers can update any employee profile
      // Employees can update their own profile, but cannot change their role
      allow update: if request.auth != null && (
        getRole() == 'manager' ||
        (request.auth.uid == employeeId && request.resource.data.role == resource.data.role)
      );

      // Managers can delete any employee profile
      allow delete: if request.auth != null && getRole() == 'manager';
    }

    // Rules for the 'clients' collection
    match /clients/{clientId} {
      // Any authenticated user can read client data (covered by global read)
      
      // Managers can create, update, and delete clients
      allow write: if request.auth != null && getRole() == 'manager';
    }

    // Rules for the 'shifts' collection
    match /shifts/{shiftId} {
      // Any authenticated user can read shifts (covered by global read)
      
      // Managers can create, update, and delete shifts
      allow write: if request.auth != null && getRole() == 'manager';
    }

    // Rules for 'timeOffRequests' collection
    match /timeOffRequests/{requestId} {
      // Any authenticated user can read time-off requests (covered by global read)
      
      // Employees can create their own time-off requests
      allow create: if request.auth != null && request.resource.data.employeeId == request.auth.uid;

      // Employees can update/delete their own pending time-off requests
      // Managers can update/delete any time-off request
      allow update, delete: if request.auth != null && (
        getRole() == 'manager' ||
        (resource.data.employeeId == request.auth.uid) // Employees can modify their own requests
      );
    }

    // Rules for 'swapRequests' collection
    match /swapRequests/{requestId} {
      // Any authenticated user can read swap requests (covered by global read)
      
      // Employees can create their own swap requests
      allow create: if request.auth != null && request.resource.data.requestingEmployeeId == request.auth.uid;

      // Employees can update/delete their own pending swap requests
      // Managers can update/delete any swap request
      allow update, delete: if request.auth != null && (
        getRole() == 'manager' ||
        (resource.data.requestingEmployeeId == request.auth.uid) // Employees can modify their own requests
      );
    }

    // Rules for 'openClaims' collection
    match /openClaims/{claimId} {
      // Any authenticated user can read open claims (covered by global read)
      
      // Employees can create their own claims for open shifts
      allow create: if request.auth != null && request.resource.data.employeeId == request.auth.uid;

      // Employees can update/delete their own pending claims
      // Managers can update/delete any claim
      allow update, delete: if request.auth != null && (
        getRole() == 'manager' ||
        (resource.data.employeeId == request.auth.uid) // Employees can modify their own claims
      );
    }
  }
}